{
  "rules": {
    "rooms": {
      ".read": "auth != null",
      "$roomId": {
        "users": {
          ".read": "auth != null",
          "$uid": {
            ".write": "auth != null && (auth.uid === $uid || data.exists())",
            "x": { ".validate": "newData.isNumber()" },
            "y": { ".validate": "newData.isNumber()" },
            "house": { ".validate": "newData.isString() && newData.val().length <= 20" },
            "name": { ".validate": "newData.isString() && newData.val().length <= 30" },
            "isIdle": { ".validate": "newData.isBoolean()" },
            "isRunning": { ".validate": "newData.isBoolean()" },
            "direction": { ".validate": "newData.isNumber()" },
            "updatedAt": { ".validate": "newData.isNumber()" },
            "lastMoveAt": { ".validate": "newData.isNumber()" },
            "invisible": { ".validate": "newData.isBoolean()" },
            "blinded": { ".validate": "newData.isBoolean()" },
            "blindedBy": { ".validate": "newData.isString() && newData.val().length <= 30" },
            "knockedBack": { ".validate": "newData.isBoolean()" },
            "knockbackX": { ".validate": "newData.isNumber()" },
            "knockbackY": { ".validate": "newData.isNumber()" },
            "knockedBackBy": { ".validate": "newData.isString() && newData.val().length <= 30" },
            "polyjuiceAs": { ".validate": "newData.val() === null || (newData.isString() && newData.val().length <= 30)" },
            "polyjuiceHouse": { ".validate": "newData.val() === null || (newData.isString() && newData.val().length <= 20)" }
          }
        },
        
        "messages": {
          "$chatId": {
            ".read": "auth != null && (data.child('participants').child(auth.uid).val() === true || !data.exists())",
            ".write": "auth != null && (data.child('participants').child(auth.uid).val() === true || newData.child('participants').child(auth.uid).val() === true)",
            "participants": {
              ".validate": "newData.hasChildren()"
            },
            "messages": {
              "$messageId": {
                ".validate": "newData.hasChildren(['text', 'sender', 'createdAt'])",
                "text": { ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 500" },
                "sender": { ".validate": "newData.isString() && newData.val() === auth.uid" },
                "senderHouse": { ".validate": "newData.isString()" },
                "senderName": { ".validate": "newData.isString() && newData.val().length <= 30" },
                "createdAt": { ".validate": "newData.isNumber()" },
                "deliveredTo": { ".validate": "true" },
                "seenBy": { ".validate": "true" }
              }
            },
            "status": { ".validate": "true" }
          }
        },
        
        "blocks": {
          ".read": "auth != null",
          "$uid": {
            ".write": "auth != null && auth.uid === $uid"
          }
        },
        
        "reports": {
          "$reportedUid": {
            "$reporterUid": {
              ".read": "auth != null",
              ".write": "auth != null && auth.uid === $reporterUid"
            }
          }
        },
        
        "owlPost": {
          ".read": "auth != null",
          ".write": "auth != null",
          "message": { ".validate": "newData.isString() && newData.val().length <= 200" },
          "sender": { ".validate": "newData.isString() && newData.val().length <= 30" },
          "house": { ".validate": "newData.isString() && newData.val().length <= 20" },
          "timestamp": { ".validate": "newData.isNumber()" }
        },
        "weather": {
          ".read": "auth != null",
          ".write": "auth != null",
          "isRaining": { ".validate": "newData.isBoolean()" },
          "changedAt": { ".validate": "newData.isNumber()" }
        },
        "polyjuiceAlert": {
          ".read": "auth != null",
          ".write": "auth != null",
          "byUid": { ".validate": "newData.isString() && newData.val() === auth.uid" },
          "byName": { ".validate": "newData.isString() && newData.val().length <= 30" },
          "disguise": { ".validate": "newData.isString() && newData.val().length <= 30" },
          "at": { ".validate": "newData.isNumber()" },
          "expiresAt": { ".validate": "newData.isNumber()" }
        },
        
        "leaderboard": {
          ".read": "auth != null",
          ".write": "auth != null",
          "Gryffindor": { ".validate": "newData.isNumber()" },
          "Slytherin": { ".validate": "newData.isNumber()" },
          "Ravenclaw": { ".validate": "newData.isNumber()" },
          "Hufflepuff": { ".validate": "newData.isNumber()" }
        },
        
        "chosenOne": {
          ".read": "auth != null",
          ".write": "auth != null",
          "uid": { ".validate": "newData.isString()" },
          "name": { ".validate": "newData.isString() && newData.val().length <= 30" },
          "expiresAt": { ".validate": "newData.isNumber()" }
        },
        
        "galleons": {
          ".read": "auth != null",
          ".write": "auth != null"
        }
      }
    },
    
    "feedback": {
      ".read": false,
      "$feedbackId": {
        ".write": "auth != null && !data.exists()",
        ".validate": "newData.hasChildren(['rating', 'timestamp'])",
        "rating": { ".validate": "newData.isNumber() && newData.val() >= 1 && newData.val() <= 5" },
        "comment": { ".validate": "newData.isString() && newData.val().length <= 500" },
        "userName": { ".validate": "newData.isString() && newData.val().length <= 30" },
        "house": { ".validate": "newData.isString() && newData.val().length <= 20" },
        "roomId": { ".validate": "newData.isString()" },
        "timestamp": { ".validate": "newData.isNumber()" },
        "userAgent": { ".validate": "newData.isString() && newData.val().length <= 500" }
      }
    }
  }
}
